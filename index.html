<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MindMap</title>
  <meta name="theme-color" content="#f3f7ff" />
  <style>
    :root{
      --text:#0b1324;
      --stroke:rgba(11,19,36,.12);
      --shadow: 0 18px 60px rgba(10,20,40,.14);
      --grid:rgba(10,20,40,.06);
      --tool:rgba(20,28,40,.88);
      --toolText:rgba(255,255,255,.92);
      --toolStroke:rgba(255,255,255,.10);
      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.82);
    }

    *{ box-sizing:border-box; }
    html,body{
      height:100%;
      margin:0;
      color:var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(89,195,255,.28), transparent 58%),
        radial-gradient(900px 650px at 85% 20%, rgba(255,92,122,.20), transparent 60%),
        radial-gradient(1000px 700px at 55% 95%, rgba(60,224,122,.22), transparent 60%),
        linear-gradient(180deg, #f7fbff, #eef4ff 55%, #f8fbff);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    header{
      display:flex; gap:10px; align-items:center; padding:12px 14px;
      position:sticky; top:0; z-index:100;
      background: var(--glass);
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }

    .btn, select{
      appearance:none;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.70);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font: inherit;
      height: 38px;
    }
    select{ cursor:pointer; }
    .btn:hover, select:hover{ border-color: rgba(89,195,255,.45); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(89,195,255,.55); }
    .btn.danger{ border-color: rgba(255,92,122,.55); }
    .sep{ width:1px; height:26px; background:var(--stroke); margin:0 2px; }

    .stageWrap{ flex:1; position:relative; overflow:hidden; }
    .stageWrap::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 0 0, var(--grid) 1px, transparent 1px),
        radial-gradient(circle at 0 0, var(--grid) 1px, transparent 1px);
      background-size: 42px 42px, 7px 7px;
      opacity:.75;
      pointer-events:none;
      z-index:0;
    }

    .leftbar{
      position:absolute;
      left:14px; top:14px;
      z-index:80;
      background: var(--glass2);
      border:1px solid var(--stroke);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      backdrop-filter: blur(10px);
    }
    .toolbtn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(11,19,36,.10);
      background: rgba(255,255,255,.78);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      position:relative;
    }
    .toolbtn:hover{ border-color: rgba(89,195,255,.45); }
    .toolbtn.active{
      border-color: rgba(89,195,255,.8);
      box-shadow: 0 0 0 3px rgba(89,195,255,.18) inset;
    }
    .toolbtn span{ font-size:18px; }
    .toolhint{
      position:absolute;
      left:58px;
      top:50%;
      transform: translateY(-50%);
      background: rgba(20,28,40,.88);
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:12px;
      box-shadow: var(--shadow);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: .12s ease;
      z-index:120;
    }
    .toolbtn:hover .toolhint{ opacity:1; }

    #scene{
      position:absolute;
      inset:0;
      z-index:1;
      touch-action:none;
      user-select:none;
      -webkit-user-select:none;
    }
    #scene.allowSelect{
      user-select:text;
      -webkit-user-select:text;
    }

    #world{
      position:absolute;
      left:0; top:0;
      transform-origin: 0 0;
      will-change: transform;
    }

    #links{
      position:absolute;
      left:0; top:0;
      overflow:visible;
      pointer-events:none;
    }
    .link{
      stroke: rgba(30,90,150,.40);
      stroke-width: 2.2;
      fill: none;
    }

    #nodes{
      position:absolute;
      left:0; top:0;
    }

    .node{
      position:absolute;
      border-radius: 16px;
      padding: 10px 12px;
      height: 58px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 16px 26px rgba(10,20,40,.14);
      border: 1.2px solid rgba(11,19,36,.18);
      background: rgba(255,255,255,.80);
      cursor: grab;
      user-select:none;
      -webkit-user-select:none;
      min-width: 150px;
      max-width: 360px;
    }
    .node.selected{
      border-color: rgba(89,195,255,.95);
      box-shadow: 0 16px 26px rgba(10,20,40,.14), 0 0 0 3px rgba(89,195,255,.18) inset;
    }
    .node:active{ cursor: grabbing; }

    .node .text{
      flex:1 1 auto;
      line-height:1.15;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      word-break: break-word;
      cursor: default;
      text-align: center; /* default center */
      font-weight: 400;
      font-style: normal;
      width:100%;
    }

    .node.editing{
      cursor: text;
      user-select:text;
      -webkit-user-select:text;
    }
    .node.editing .text{
      outline: none;
      cursor: text;
      user-select:text;
      -webkit-user-select:text;
      -webkit-line-clamp: unset;
      display:block;
      overflow: visible;
      white-space: pre-wrap;
    }

    .collapseDot{
      position:absolute;
      width: 18px; height: 18px;
      border-radius: 999px;
      box-shadow: 0 10px 18px rgba(10,20,40,.12);
      cursor: pointer;
      user-select:none;
      -webkit-user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.90);
      border: 2px solid rgba(11,19,36,.22);
    }
    .collapseDot .inner{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: transparent;
      opacity: .35;
    }
    .collapseDot.collapsed .inner{ opacity: .70; }

    .menuTrigger{
      position:fixed;
      z-index:95;
      display:none;
      width: 18px; height: 18px;
      border-radius: 999px;
      background: rgba(255,255,255,.90);
      border:2px solid rgba(11,19,36,.22);
      box-shadow: 0 12px 26px rgba(10,20,40,.16);
      color: rgba(11,19,36,.80);
      align-items:center;
      justify-content:center;
      font-size: 14px;
      line-height: 1;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      backdrop-filter: blur(10px);
    }
    .menuTrigger:hover{
      box-shadow: 0 12px 26px rgba(10,20,40,.16), 0 0 0 3px rgba(89,195,255,.16);
    }

    .ctx{
      position:fixed;
      z-index:96;
      background: var(--tool);
      color: var(--toolText);
      border:1px solid var(--toolStroke);
      border-radius:14px;
      box-shadow: var(--shadow);
      display:none;
      gap:6px;
      padding:8px;
      align-items:center;
      backdrop-filter: blur(10px);
      user-select:none;
      -webkit-user-select:none;
    }
    .ctx .cbtn{
      width:34px; height:34px;
      display:flex; align-items:center; justify-content:center;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:16px;
    }
    .ctx .cbtn:hover{ border-color: rgba(89,195,255,.50); }
    .ctx .cbtn.on{
      border-color: rgba(89,195,255,.70);
      box-shadow: 0 0 0 2px rgba(89,195,255,.18) inset;
    }
    .ctx .csep{ width:1px; height:22px; background: rgba(255,255,255,.12); margin:0 2px; }
    .ctx .label{ font-size:12px; color: rgba(255,255,255,.70); padding:0 6px 0 2px; }

    .emojiPop{
      position:fixed;
      z-index:97;
      display:none;
      width: 308px;
      max-height: 220px;
      overflow:auto;
      background: rgba(20,28,40,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      box-shadow: var(--shadow);
      padding:10px;
      backdrop-filter: blur(10px);

      /* keep scrollbar visually inside rounded corners */
      overscroll-behavior: contain;
      scrollbar-gutter: stable both-edges;
    }

    /* Dark, integrated scrollbar */
    .emojiPop::-webkit-scrollbar{
      width: 10px;
      height: 10px;
    }
    .emojiPop::-webkit-scrollbar-track{
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      margin: 8px;
    }
    .emojiPop::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border-radius: 12px;
      border: 2px solid rgba(20,28,40,.92);
    }
    .emojiPop::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.26);
    }
    /* Firefox */
    .emojiPop{
      scrollbar-color: rgba(255,255,255,.22) rgba(255,255,255,.06);
      scrollbar-width: thin;
    }

    .emojiGrid{
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:6px;
    }
    .emojiCell{
      width: 26px; height: 26px;
      display:flex; align-items:center; justify-content:center;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:16px;
      user-select:none;
      -webkit-user-select:none;
    }
    .emojiCell:hover{ border-color: rgba(89,195,255,.50); }

    .toast{
      position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
      background: rgba(255,255,255,.72);
      border:1px solid rgba(11,19,36,.14);
      padding:10px 12px; border-radius:12px;
      color:rgba(11,19,36,.86);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      max-width:min(720px, calc(100% - 24px));
      z-index:110;
    }
    .toast.show{ opacity:1; }

    input[type="file"]{ display:none; }
  </style>
</head>
<body>
<div class="app">
  <header id="topbar">
    <select id="projectSelect" title="–ú–∞–π–Ω–¥–º—ç–ø"></select>
    <button class="btn primary" id="projNew">+ –ù–æ–≤—ã–π</button>
    <button class="btn" id="projRename">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
    <button class="btn" id="projDup">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="btn danger" id="projDel">–£–¥–∞–ª–∏—Ç—å</button>

    <div class="sep"></div>

    <button class="btn" id="autoLayout">–ê–≤—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥–∫–∞</button>
    <button class="btn" id="resetView">–°–±—Ä–æ—Å –≤–∏–¥–∞</button>

    <div class="sep"></div>

    <button class="btn" id="exportOne">–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã</button>
    <label class="btn" for="importOne">–ò–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã</label>
    <input id="importOne" type="file" accept="application/json" />

    <button class="btn" id="exportAll">–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö</button>
    <label class="btn" for="importAll">–ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö</label>
    <input id="importAll" type="file" accept="application/json" />
  </header>

  <div class="stageWrap" id="wrap">
    <div class="leftbar" id="leftbar">
      <div class="toolbtn active" data-tool="select"><span>üñ±Ô∏è</span><div class="toolhint">Select (V)</div></div>
      <div class="toolbtn" data-tool="hand"><span>‚úã</span><div class="toolhint">Hand/Pan (H)</div></div>
      <div class="toolbtn" data-tool="node"><span>‚ûï</span><div class="toolhint">Add node (N) ‚Äî –∫–ª–∏–∫ –ø–æ –ø–æ–ª—é</div></div>
      <div class="toolbtn" data-tool="center"><span>üéØ</span><div class="toolhint">Center on selection (C)</div></div>
    </div>

    <div class="menuTrigger" id="menuTrigger" title="–ú–µ–Ω—é">‚ãØ</div>

    <div class="ctx" id="ctx">
      <div class="label">–£–∑–µ–ª</div>
      <div class="cbtn" id="ctxChild" title="–î–æ—á–µ—Ä–Ω–∏–π">‚Ü≥</div>
      <div class="cbtn" id="ctxSibling" title="–°–æ—Å–µ–¥–Ω–∏–π">‚Ü¶</div>
      <div class="cbtn" id="ctxRename" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</div>

      <div class="csep"></div>

      <div class="cbtn" id="ctxBold" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></div>
      <div class="cbtn" id="ctxItalic" title="–ö—É—Ä—Å–∏–≤"><i>I</i></div>
      <div class="csep"></div>
      <div class="cbtn" id="ctxAlignL" title="–ü–æ –ª–µ–≤–æ–º—É">‚á§</div>
      <div class="cbtn" id="ctxAlignC" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚â°</div>
      <div class="cbtn" id="ctxAlignR" title="–ü–æ –ø—Ä–∞–≤–æ–º—É">‚á•</div>

      <div class="csep"></div>

      <div class="cbtn" id="ctxColor" title="–¶–≤–µ—Ç">üé®</div>
      <div class="cbtn" id="ctxEmoji" title="–≠–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç">üòä</div>
      <div class="cbtn" id="ctxCollapse" title="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚§µÔ∏è</div>

      <div class="csep"></div>

      <div class="cbtn" id="ctxDelete" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</div>
      <div class="cbtn" id="ctxClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úñ</div>
    </div>

    <div class="emojiPop" id="emojiPop">
      <div class="emojiGrid" id="emojiGrid"></div>
    </div>

    <div id="scene">
      <div id="world">
        <svg id="links" xmlns="http://www.w3.org/2000/svg"></svg>
        <div id="nodes"></div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>
</div>

<script>
(() => {
  const STORE_KEY = "mindmap_projects_v6";

  const TRIGGER_HOLD_MS = 1600; // —É–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —É—Ö–æ–¥–∞ –∫—É—Ä—Å–æ—Ä–∞

  const PALETTE = [
    {name:"Sky",    fill:"rgba(89,195,255,.20)", stroke:"rgba(33,140,210,.62)"},
    {name:"Rose",   fill:"rgba(255,92,122,.18)", stroke:"rgba(230,70,95,.64)"},
    {name:"Lime",   fill:"rgba(60,224,122,.18)", stroke:"rgba(30,170,85,.62)"},
    {name:"Amber",  fill:"rgba(255,209,102,.20)", stroke:"rgba(205,150,40,.64)"},
    {name:"Violet", fill:"rgba(176,122,255,.18)", stroke:"rgba(135,90,210,.64)"},
    {name:"Slate",  fill:"rgba(255,255,255,.80)", stroke:"rgba(11,19,36,.18)"}
  ];

  const EMOJIS = [
    "üí°","‚úÖ","üéØ","üìå","üß†","‚ö°","üß©","üî•","üìé","üîó","‚≠ê","üìù","üìö","üß™","üêû","üß≠",
    "üöÄ","üß±","üóÇÔ∏è","üìà","üìä","üß∑","üßµ","üß≤","üß∞","ü™Ñ","üíé","üóùÔ∏è","üßø","üß∏","ü´ß","üåø",
    "üì£","üéõÔ∏è","üéöÔ∏è","üéß","üéµ","üé¨","üì∑","üßæ","üóíÔ∏è","‚úçÔ∏è","üßë‚Äçüíª","üßë‚Äçüè´","üßë‚Äçüé®","üßë‚Äçüîß","üßë‚Äçüíº","ü§ù",
    "‚ùó","‚ùì","üü¢","üü°","üî¥","üü£","üîµ","‚ö™","‚ö´","üüß","üü¶","üü©","üü•","üü®","üü™","üü´"
  ];

  const wrap = document.getElementById("wrap");
  const topbar = document.getElementById("topbar");
  const scene = document.getElementById("scene");
  const world = document.getElementById("world");
  const linksSvg = document.getElementById("links");
  const nodesLayer = document.getElementById("nodes");
  const toast = document.getElementById("toast");

  const ctx = document.getElementById("ctx");
  const menuTrigger = document.getElementById("menuTrigger");
  const emojiPop = document.getElementById("emojiPop");
  const emojiGrid = document.getElementById("emojiGrid");

  let ctxOpen = false;
  let emojiOpen = false;

  const projectSelect = document.getElementById("projectSelect");
  const importOne = document.getElementById("importOne");
  const importAll = document.getElementById("importAll");

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const nowTs = () => Date.now();

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove("show"), 1400);
  }

  const measureCanvas = document.createElement("canvas");
  const mctx = measureCanvas.getContext("2d");
  const FONT = "14px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
  function measureNode(text){
    mctx.font = FONT;
    const t = (text || "").trim() || "–ò–¥–µ—è";
    const raw = mctx.measureText(t).width;
    const minW = 150;
    const maxW = 360;
    const w = Math.max(minW, Math.min(maxW, Math.ceil(raw + 48)));
    const h = 58;
    return {w,h};
  }

  let store = null;
  let active = null;
  let map = null;

  let tool = "select";
  let selectedId = null;
  let editingId = null;

  const DRAG_THRESHOLD = 6;
  let drag = null;

  const pointers = new Map();
  let pinch = null;

  const tap = { id:null, count:0, t:0, timer:null };
  const TAP_WINDOW = 420;

  // Hover "sticky" for trigger
  let hoverNodeId = null;
  let hoverTrigger = false;

  // Fixed owner while menu is open
  let lockedOwnerId = null;

  // Keep trigger visible briefly after leaving
  let triggerHoldUntil = 0;
  let holdTimer = null;

  function saveStore(){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch(e){}
  }
  function loadStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (raw){
        const obj = JSON.parse(raw);
        if (obj && obj.projects && typeof obj.projects === "object") return obj;
      }
    }catch(e){}
    return null;
  }

  function normalizeMapData(data){
    data.view ||= {x:24,y:24,k:1};
    data.nodes ||= [];
    data.links ||= [];
    data.nodes.forEach(n => {
      n.text ||= "–ò–¥–µ—è";
      if ("icon" in n) delete n.icon;

      n.style ||= { fill: PALETTE[0].fill, stroke: PALETTE[0].stroke };
      n.childColorNext ||= 0;
      n.parentId = n.parentId || null;
      n.collapsed = !!n.collapsed;

      // default center unless already set
      n.fmt ||= { bold:false, italic:false, align:"center" };
      if (!n.fmt.align) n.fmt.align = "center";

      const m = measureNode(n.text);
      n.w = m.w; n.h = m.h;
    });
    data.links = data.links.filter(l => l && l.a && l.b && l.a !== l.b);
    return data;
  }

  function createEmptyProject(name="–ù–æ–≤—ã–π –º–∞–π–Ω–¥–º—ç–ø"){
    const id = uid();
    const data = normalizeMapData({ nodes: [], links: [], view:{x:24,y:24,k:1} });

    const centerId = uid();
    const m = measureNode("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–¥–µ—è");
    data.nodes.push({
      id:centerId, x:260, y:180, w:m.w, h:m.h,
      text:"–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–¥–µ—è",
      style:{fill: PALETTE[0].fill, stroke: PALETTE[0].stroke},
      childColorNext:0,
      parentId:null,
      collapsed:false,
      fmt:{bold:false, italic:false, align:"center"}
    });

    const p = { id, name, createdAt: nowTs(), updatedAt: nowTs(), data };
    store.projects[id] = p;
    store.activeId = id;
    saveStore();
    return p;
  }

  function rebuildProjectSelect(){
    projectSelect.innerHTML = "";
    const ids = Object.keys(store.projects)
      .map(id => store.projects[id])
      .sort((a,b) => (b.updatedAt||0) - (a.updatedAt||0))
      .map(p => p.id);

    for (const id of ids){
      const p = store.projects[id];
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = p.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
      if (id === store.activeId) opt.selected = true;
      projectSelect.appendChild(opt);
    }
  }

  function setActiveProject(id){
    const p = store.projects[id];
    if (!p) return;
    store.activeId = id;
    active = p;
    map = normalizeMapData(JSON.parse(JSON.stringify(p.data)));
    selectedId = null;
    editingId = null;
    drag = null;
    closeAllPopups(true);
    saveStore();
    rebuildProjectSelect();
    renderAll();
  }

  function commitMap(){
    if (!active) return;
    active.updatedAt = nowTs();
    active.data = JSON.parse(JSON.stringify(map));
    saveStore();
  }
  function autosave(){
    clearTimeout(autosave._t);
    autosave._t = setTimeout(() => commitMap(), 250);
  }

  function getNode(id){ return map.nodes.find(n => n.id === id); }
  function childrenOf(id){ return map.nodes.filter(n => n.parentId === id).map(n => n.id); }

  function isHiddenByCollapse(nodeId){
    let cur = getNode(nodeId);
    while(cur && cur.parentId){
      const p = getNode(cur.parentId);
      if (p && p.collapsed) return true;
      cur = p;
    }
    return false;
  }

  function addLink(a,b){
    if (!a || !b || a===b) return;
    const exists = map.links.some(l => (l.a===a && l.b===b) || (l.a===b && l.b===a));
    if (exists) return;
    map.links.push({ id: uid(), a, b });
  }

  function addNodeAt(x,y, text="–ù–æ–≤–∞—è –∏–¥–µ—è", style=PALETTE[0]){
    drag = null;
    const m = measureNode(text);
    const id = uid();
    map.nodes.push({
      id, x, y, w:m.w, h:m.h,
      text,
      style: {fill: style.fill, stroke: style.stroke},
      childColorNext: 0,
      parentId: null,
      collapsed: false,
      fmt:{bold:false, italic:false, align:"center"} // default center
    });
    selectedId = id;
    closeAllPopups(false);
    autosave();
    renderAll();
    return id;
  }

  function addChildFrom(parentId){
    const parent = getNode(parentId);
    if (!parent) return null;
    drag = null;

    const idx = ((parent.childColorNext||0) + 1) % PALETTE.length;
    parent.childColorNext = (parent.childColorNext||0) + 1;
    const style = PALETTE[idx];

    const x = parent.x + parent.w + 140;
    const y = parent.y + (Math.random()*70 - 35);

    const id = uid();
    const m = measureNode("–î–æ—á–µ—Ä–Ω—è—è –∏–¥–µ—è");
    map.nodes.push({
      id, x, y, w:m.w, h:m.h,
      text:"–î–æ—á–µ—Ä–Ω—è—è –∏–¥–µ—è",
      style:{fill: style.fill, stroke: style.stroke},
      childColorNext: 0,
      parentId: parentId,
      collapsed:false,
      fmt:{bold:false, italic:false, align:"center"} // default center
    });
    addLink(parentId, id);

    selectedId = id;
    closeAllPopups(false);
    autosave();
    renderAll();
    return id;
  }

  function addSiblingFrom(nodeId){
    const n = getNode(nodeId);
    if (!n) return null;
    drag = null;

    const parentId = n.parentId || null;
    const x = n.x;
    const y = n.y + n.h + 18;

    const id = uid();
    const m = measureNode("–ù–æ–≤–∞—è –∏–¥–µ—è");
    map.nodes.push({
      id, x, y, w:m.w, h:m.h,
      text:"–ù–æ–≤–∞—è –∏–¥–µ—è",
      style: n.style ? {fill:n.style.fill, stroke:n.style.stroke} : {fill:PALETTE[0].fill, stroke:PALETTE[0].stroke},
      childColorNext: 0,
      parentId,
      collapsed:false,
      fmt:{bold:false, italic:false, align:"center"} // default center
    });
    if (parentId) addLink(parentId, id);

    selectedId = id;
    closeAllPopups(false);
    autosave();
    renderAll();
    return id;
  }

  function deleteSubtree(id){
    drag = null;
    const ids = new Set();
    const stack = [id];
    while(stack.length){
      const v = stack.pop();
      ids.add(v);
      for (const c of childrenOf(v)) stack.push(c);
    }
    map.nodes = map.nodes.filter(n => !ids.has(n.id));
    map.links = map.links.filter(l => !ids.has(l.a) && !ids.has(l.b));
    if (selectedId && ids.has(selectedId)) selectedId = null;
    closeAllPopups(true);
    autosave();
    renderAll();
  }

  function toggleCollapse(id){
    const n = getNode(id);
    if (!n) return;
    n.collapsed = !n.collapsed;
    autosave();
    renderAll();
  }

  function applyTransform(){
    const v = map.view;
    world.style.transform = `translate(${v.x}px, ${v.y}px) scale(${v.k})`;
  }

  function clientToWorld(cx, cy){
    const r = scene.getBoundingClientRect();
    const v = map.view;
    return {
      x: (cx - r.left - v.x) / v.k,
      y: (cy - r.top  - v.y) / v.k
    };
  }

  function edgePoint(fromNode, toNode){
    const cx = fromNode.x + fromNode.w/2;
    const cy = fromNode.y + fromNode.h/2;
    const tx = toNode.x + toNode.w/2;
    const ty = toNode.y + toNode.h/2;
    let dx = tx - cx, dy = ty - cy;
    if (dx === 0 && dy === 0) { dx = 1; dy = 0; }

    const hw = fromNode.w/2, hh = fromNode.h/2;
    const adx = Math.abs(dx), ady = Math.abs(dy);
    const sx = adx ? (hw / adx) : Infinity;
    const sy = ady ? (hh / ady) : Infinity;
    const t = Math.min(sx, sy);
    return { x: cx + dx * t, y: cy + dy * t };
  }

  function drawLinks(){
    const maxX = Math.max(2000, ...map.nodes.map(n => n.x + n.w + 300));
    const maxY = Math.max(1400, ...map.nodes.map(n => n.y + n.h + 300));
    linksSvg.setAttribute("width", maxX);
    linksSvg.setAttribute("height", maxY);

    linksSvg.innerHTML = "";
    for (const l of map.links){
      const a = getNode(l.a), b = getNode(l.b);
      if (!a || !b) continue;
      if (isHiddenByCollapse(a.id) || isHiddenByCollapse(b.id)) continue;

      const p1 = edgePoint(a, b);
      const p2 = edgePoint(b, a);
      const dx = p2.x - p1.x;
      const c1x = p1.x + dx * 0.33;
      const c2x = p1.x + dx * 0.66;
      const d = `M ${p1.x} ${p1.y} C ${c1x} ${p1.y}, ${c2x} ${p2.y}, ${p2.x} ${p2.y}`;

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", d);
      path.setAttribute("class","link");
      linksSvg.appendChild(path);
    }
  }

  function renderSelectionOnly(){
    [...nodesLayer.querySelectorAll(".node")].forEach(el => {
      el.classList.toggle("selected", el.getAttribute("data-id") === selectedId);
    });
  }

  function applyNodeFmt(nodeEl, n){
    const textEl = nodeEl.querySelector(".text");
    const fmt = n.fmt || {bold:false, italic:false, align:"center"};
    textEl.style.fontWeight = fmt.bold ? "700" : "400";
    textEl.style.fontStyle = fmt.italic ? "italic" : "normal";
    textEl.style.textAlign = fmt.align || "center";
  }

  function scheduleTriggerHold(){
    triggerHoldUntil = Date.now() + TRIGGER_HOLD_MS;
    clearTimeout(holdTimer);
    holdTimer = setTimeout(() => {
      positionTriggerAndMenus();
    }, TRIGGER_HOLD_MS + 30);
  }

  function renderNodes(){
    nodesLayer.innerHTML = "";

    for (const n of map.nodes){
      if (isHiddenByCollapse(n.id)) continue;

      const div = document.createElement("div");
      div.className = "node" + (n.id === selectedId ? " selected" : "");
      div.style.left = n.x + "px";
      div.style.top  = n.y + "px";
      div.style.width = n.w + "px";
      div.style.height = n.h + "px";
      div.style.background = n.style?.fill || "rgba(255,255,255,.80)";
      div.style.borderColor = n.style?.stroke || "rgba(11,19,36,.18)";
      div.setAttribute("data-id", n.id);

      const text = document.createElement("div");
      text.className = "text";
      text.textContent = n.text || "";
      div.appendChild(text);

      applyNodeFmt(div, n);

      div.addEventListener("mouseenter", () => {
        if (ctxOpen) return; // –∫–æ–≥–¥–∞ –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ ‚Äî –Ω–µ –º–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ—Ç hover
        hoverNodeId = n.id;
        positionTriggerAndMenus();
      });
      div.addEventListener("mouseleave", () => {
        if (ctxOpen) return;
        hoverNodeId = null;
        scheduleTriggerHold();
        setTimeout(() => positionTriggerAndMenus(), 0);
      });

      div.addEventListener("pointerdown", (e) => {
        if (editingId) return
