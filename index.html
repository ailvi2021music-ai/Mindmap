<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>MindMap</title>
  <meta name="theme-color" content="#f3f7ff"/>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --text:#0b1324;
      --stroke:rgba(11,19,36,.12);
      --shadow: 0 18px 60px rgba(10,20,40,.14);
      --grid:rgba(10,20,40,.06);
      --glass: rgba(255,255,255,.72);
    }

    *{ box-sizing:border-box; }
    html,body{
      height:100%;
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      overflow:hidden;
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(89,195,255,.28), transparent 58%),
        radial-gradient(900px 650px at 85% 20%, rgba(255,92,122,.20), transparent 60%),
        radial-gradient(1000px 700px at 55% 95%, rgba(60,224,122,.22), transparent 60%),
        linear-gradient(180deg, #f7fbff, #eef4ff 55%, #f8fbff);
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    header{
      display:flex; gap:10px; align-items:center; padding:12px 14px;
      position:sticky; top:0; z-index:100;
      background: var(--glass);
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.70);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      box-shadow: 0 8px 22px rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font: 600 14px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      height: 38px;
    }
    .btn:hover{ border-color: rgba(89,195,255,.45); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(89,195,255,.55); }

    .dd{ position:relative; min-width:240px; }
    .ddBtn{ width:100%; justify-content:space-between; font-weight:600; }
    .ddList{
      position:absolute; top: 44px; left:0; right:0;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(11,19,36,.12);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 8px;
      display:none;
      max-height: 320px;
      overflow:auto;
      backdrop-filter: blur(10px);
      z-index: 200;
    }
    .ddItem{
      width:100%;
      border: 1px solid rgba(11,19,36,.10);
      background: rgba(255,255,255,.72);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin: 6px 0;
      user-select:none;
      font-weight:600;
    }
    .ddItem:hover{ border-color: rgba(89,195,255,.45); }
    .ddMeta{ font-weight:600; font-size:12px; color: rgba(11,19,36,.55); }

    .menuWrap{ position:relative; }
    .drop{
      position:absolute; top: 44px; right: 0;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(11,19,36,.12);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 8px;
      display:none;
      min-width: 240px;
      backdrop-filter: blur(10px);
      z-index: 200;
    }
    .drop .item{
      width:100%;
      border: 1px solid rgba(11,19,36,.10);
      background: rgba(255,255,255,.72);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      display:flex;
      justify-content:flex-start;
      gap:10px;
      align-items:center;
      margin: 6px 0;
      user-select:none;
      font-weight:600;
    }
    .drop .item:hover{ border-color: rgba(89,195,255,.45); }
    input[type="file"]{ display:none; }

    .stageWrap{
      flex:1;
      position:relative;
      overflow:hidden;

      /* –í–ê–ñ–ù–û: –Ω–µ –¥–∞—ë–º –Ø–Ω–¥–µ–∫—Å—É –¥—É–º–∞—Ç—å, —á—Ç–æ —Ç—É—Ç –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å —Ç–µ–∫—Å—Ç */
      user-select:none;
      -webkit-user-select:none;
      -ms-user-select:none;
      -moz-user-select:none;
    }
    .stageWrap::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 0 0, var(--grid) 1px, transparent 1px),
        radial-gradient(circle at 0 0, var(--grid) 1px, transparent 1px);
      background-size: 42px 42px, 7px 7px;
      opacity:.75;
      pointer-events:none;
      z-index:0;
    }

    #svg{
      position:absolute; inset:0;
      z-index:1;
      touch-action:none;
      user-select:none;
      -webkit-user-select:none;
    }

    .toast{
      position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
      background: rgba(255,255,255,.78);
      border:1px solid rgba(11,19,36,.14);
      padding:10px 12px; border-radius:12px;
      color:rgba(11,19,36,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      max-width:min(900px, calc(100% - 24px));
      z-index:110;
      font-weight:700;
      white-space:pre-wrap;
    }
    .toast.show{ opacity:1; }

    #editor{
      position:absolute;
      z-index: 300;
      display:none;
      border-radius: 14px;
      border: 2px solid rgba(89,195,255,.75);
      box-shadow: var(--shadow);
      padding: 12px 14px;
      font: 600 16px/1.25 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      resize:none;
      outline:none;
      background: rgba(255,255,255,.95);
      color: var(--text);
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <div class="dd" id="projDD">
      <button class="btn ddBtn" id="projBtn">
        <span id="projBtnText">–ú–∞–π–Ω–¥–º—ç–ø</span>
        <span style="opacity:.7">‚ñæ</span>
      </button>
      <div class="ddList" id="projList"></div>
    </div>

    <button class="btn primary" id="projNew">+ –ù–æ–≤—ã–π</button>

    <div class="menuWrap">
      <button class="btn" id="downloadBtn">–°–∫–∞—á–∞—Ç—å ‚ñæ</button>
      <div class="drop" id="downloadDrop">
        <div class="item" id="exportOneBtn">–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã</div>
        <label class="item" for="importOne">–ò–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã</label>
        <div class="item" id="exportAllBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö</div>
        <label class="item" for="importAll">–ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö</label>
      </div>
    </div>

    <input id="importOne" type="file" accept="application/json"/>
    <input id="importAll" type="file" accept="application/json"/>
  </header>

  <div class="stageWrap" id="wrap">
    <svg id="svg" xmlns="http://www.w3.org/2000/svg">
      <g id="world">
        <g id="links"></g>
        <g id="nodes"></g>
        <g id="dots" style="display:none; cursor:pointer;"></g>
        <g id="ctx" style="display:none;"></g>
      </g>
    </svg>

    <textarea id="editor" rows="2"></textarea>
    <div class="toast" id="toast"></div>
  </div>
</div>

<script>
(() => {
  const STORE_KEY = "mindmap_projects_v9_svg_safe";

  const PALETTE = [
    {fill:"rgba(89,195,255,.20)", stroke:"rgba(33,140,210,.62)"},
    {fill:"rgba(255,92,122,.18)", stroke:"rgba(230,70,95,.64)"},
    {fill:"rgba(60,224,122,.18)", stroke:"rgba(30,170,85,.62)"},
    {fill:"rgba(255,209,102,.20)", stroke:"rgba(205,150,40,.64)"},
    {fill:"rgba(176,122,255,.18)", stroke:"rgba(135,90,210,.64)"},
    {fill:"rgba(255,255,255,.80)", stroke:"rgba(11,19,36,.18)"}
  ];

  const svg = document.getElementById("svg");
  const world = document.getElementById("world");
  const linksG = document.getElementById("links");
  const nodesG = document.getElementById("nodes");
  const dotsG = document.getElementById("dots");
  const ctxG  = document.getElementById("ctx");
  const wrap = document.getElementById("wrap");
  const toast = document.getElementById("toast");
  const editor = document.getElementById("editor");

  const projBtn = document.getElementById("projBtn");
  const projBtnText = document.getElementById("projBtnText");
  const projList = document.getElementById("projList");
  const projNew = document.getElementById("projNew");

  const downloadBtn = document.getElementById("downloadBtn");
  const downloadDrop = document.getElementById("downloadDrop");
  const exportOneBtn = document.getElementById("exportOneBtn");
  const exportAllBtn = document.getElementById("exportAllBtn");
  const importOne = document.getElementById("importOne");
  const importAll = document.getElementById("importAll");

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const nowTs = () => Date.now();

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove("show"), 2200);
  }

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ "–±–µ–ª–æ–≥–æ —ç–∫—Ä–∞–Ω–∞"
  window.addEventListener("error", (e) => {
    showToast("–û—à–∏–±–∫–∞: " + (e.message || e.error || "unknown"));
  });
  window.addEventListener("unhandledrejection", (e) => {
    showToast("–û—à–∏–±–∫–∞: " + (e.reason?.message || e.reason || "promise rejection"));
  });

  // ---------- SVG-safe helpers (–≤–∞–∂–Ω–æ –¥–ª—è –Ø–Ω–¥–µ–∫—Å–∞) ----------
  function safeMatches(el, selector){
    if (!el) return false;
    const fn = el.matches || el.msMatchesSelector || el.webkitMatchesSelector;
    if (fn) return fn.call(el, selector);
    return false;
  }
  function safeClosest(el, selector){
    let cur = el;
    while(cur){
      if (cur.nodeType === 1 && safeMatches(cur, selector)) return cur;
      cur = cur.parentNode;
    }
    return null;
  }

  // ---------- Storage ----------
  function saveStore(){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(store)); }catch(e){}
  }
  function loadStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (obj && obj.projects && typeof obj.projects === "object") return obj;
    }catch(e){}
    return null;
  }

  function createEmptyProject(name="–ù–æ–≤—ã–π –º–∞–π–Ω–¥–º—ç–ø"){
    const id = uid();
    const centerId = uid();
    const data = {
      view:{x: 140, y: 110, k: 1},
      nodes: [{
        id:centerId,
        x: 240, y: 180,
        text:"–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∏–¥–µ—è",
        style:{...PALETTE[0]},
        parentId:null,
        collapsed:false,
        childColorNext:0,
        fmt:{bold:false, italic:false, align:"center"}
      }],
      links: []
    };
    const p = { id, name, createdAt: nowTs(), updatedAt: nowTs(), data };
    store.projects[id] = p;
    store.activeId = id;
    saveStore();
    return p;
  }

  // —Å—Ç–∞—Ä—Ç—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É—Å—Ç–æ–π—á–∏–≤–æ
  let store = loadStore();
  if (!store || !store.projects || typeof store.projects !== "object"){
    store = { activeId:null, projects:{} };
  }
  if (!Object.keys(store.projects).length){
    createEmptyProject("–ú–æ–π –ø–µ—Ä–≤—ã–π –º–∞–π–Ω–¥–º—ç–ø");
  }
  if (!store.activeId || !store.projects[store.activeId]){
    store.activeId = Object.keys(store.projects)[0];
    saveStore();
  }

  let active = null;
  let map = null;
  let selectedId = null;
  let editingId = null;
  let ctxOpen = false;

  function commitMap(){
    if (!active || !map) return;
    active.updatedAt = nowTs();
    active.data = JSON.parse(JSON.stringify(map));
    saveStore();
  }
  function autosave(){
    clearTimeout(autosave._t);
    autosave._t = setTimeout(commitMap, 250);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function safeName(s){ return (s||"mindmap").replace(/[^\w\d\-_.]+/g,"_"); }
  function downloadJson(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---------- geometry ----------
  function applyTransform(){
    const v = map.view;
    world.setAttribute("transform", `translate(${v.x} ${v.y}) scale(${v.k})`);
  }
  function clientToWorld(cx, cy){
    const r = svg.getBoundingClientRect();
    const v = map.view;
    return { x: (cx - r.left - v.x) / v.k, y: (cy - r.top - v.y) / v.k };
  }
  function worldToClient(wx, wy){
    const r = svg.getBoundingClientRect();
    const v = map.view;
    return { x: r.left + v.x + wx * v.k, y: r.top + v.y + wy * v.k };
  }
  function getNode(id){ return map.nodes.find(n => n.id === id); }
  function childrenOf(id){ return map.nodes.filter(n => n.parentId === id).map(n => n.id); }
  function isHiddenByCollapse(nodeId){
    let cur = getNode(nodeId);
    while(cur && cur.parentId){
      const p = getNode(cur.parentId);
      if (p && p.collapsed) return true;
      cur = p;
    }
    return false;
  }

  function clear(g){ while(g.firstChild) g.removeChild(g.firstChild); }

  function measureTextWidth(text, weight=600, size=16){
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", -9999);
    t.setAttribute("y", -9999);
    t.style.fontFamily = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
    t.style.fontWeight = String(weight);
    t.style.fontSize = size + "px";
    t.textContent = text || "";
    svg.appendChild(t);
    const w = t.getBBox().width;
    svg.removeChild(t);
    return w;
  }
  function nodeBox(n){
    const padX = 22;
    const minW = 170;
    const maxW = 520;
    const fontSize = 20;
    const weight = (n.fmt && n.fmt.bold) ? 700 : 600;
    const txt = (n.text || "").trim() || "–ò–¥–µ—è";
    const w = Math.max(minW, Math.min(maxW, Math.ceil(measureTextWidth(txt, weight, fontSize) + padX*2)));
    const h = 64;
    return {w,h, fontSize, weight};
  }

  function addLink(a,b){
    if (!a || !b || a===b) return;
    const exists = map.links.some(l => (l.a===a && l.b===b) || (l.a===b && l.b===a));
    if (exists) return;
    map.links.push({ id: uid(), a, b });
  }

  function addChildFrom(parentId){
    const p = getNode(parentId);
    if (!p) return null;
    const idx = ((p.childColorNext||0) + 1) % PALETTE.length;
    p.childColorNext = (p.childColorNext||0) + 1;
    const style = PALETTE[idx];

    const id = uid();
    map.nodes.push({
      id,
      x: p.x + 260,
      y: p.y + (Math.random()*80 - 40),
      text:"–î–æ—á–µ—Ä–Ω—è—è –∏–¥–µ—è",
      style:{...style},
      parentId: parentId,
      collapsed:false,
      childColorNext:0,
      fmt:{bold:false, italic:false, align:"center"}
    });
    addLink(parentId, id);
    selectedId = id;
    ctxOpen = false;
    autosave();
    renderAll();
    beginEdit(id, true);
    return id;
  }

  function deleteSubtree(id){
    const ids = new Set();
    const stack = [id];
    while(stack.length){
      const v = stack.pop();
      ids.add(v);
      for (const c of childrenOf(v)) stack.push(c);
    }
    map.nodes = map.nodes.filter(n => !ids.has(n.id));
    map.links = map.links.filter(l => !ids.has(l.a) && !ids.has(l.b));
    if (selectedId && ids.has(selectedId)) selectedId = null;
    ctxOpen = false;
    autosave();
    renderAll();
  }

  function toggleCollapse(id){
    const n = getNode(id);
    if (!n) return;
    n.collapsed = !n.collapsed;
    autosave();
    renderAll();
  }

  function edgePoint(from, to){
    const b1 = nodeBox(from);
    const b2 = nodeBox(to);
    const cx = from.x + b1.w/2, cy = from.y + b1.h/2;
    const tx = to.x + b2.w/2, ty = to.y + b2.h/2;
    let dx = tx - cx, dy = ty - cy;
    if (dx === 0 && dy === 0) { dx = 1; dy = 0; }

    const hw = b1.w/2, hh = b1.h/2;
    const adx = Math.abs(dx), ady = Math.abs(dy);
    const sx = adx ? (hw / adx) : Infinity;
    const sy = ady ? (hh / ady) : Infinity;
    const t = Math.min(sx, sy);
    return { x: cx + dx*t, y: cy + dy*t };
  }

  function renderLinks(){
    clear(linksG);
    for (const l of map.links){
      const a = getNode(l.a), b = getNode(l.b);
      if (!a || !b) continue;
      if (isHiddenByCollapse(a.id) || isHiddenByCollapse(b.id)) continue;

      const p1 = edgePoint(a,b);
      const p2 = edgePoint(b,a);
      const dx = p2.x - p1.x;

      const c1x = p1.x + dx * 0.33;
      const c2x = p1.x + dx * 0.66;

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", `M ${p1.x} ${p1.y} C ${c1x} ${p1.y}, ${c2x} ${p2.y}, ${p2.x} ${p2.y}`);
      path.setAttribute("fill","none");
      path.setAttribute("stroke","rgba(30,90,150,.45)");
      path.setAttribute("stroke-width","3");
      path.setAttribute("stroke-linecap","round");
      linksG.appendChild(path);
    }
  }

  function renderNodes(){
    clear(nodesG);

    for (const n of map.nodes){
      if (isHiddenByCollapse(n.id)) continue;

      const {w,h,fontSize,weight} = nodeBox(n);

      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("data-id", n.id);
      g.setAttribute("transform", `translate(${n.x} ${n.y})`);
      g.style.cursor = editingId ? "default" : "grab";

      const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
      rect.setAttribute("width", w);
      rect.setAttribute("height", h);
      rect.setAttribute("rx", 18);
      rect.setAttribute("fill", n.style?.fill || "rgba(255,255,255,.8)");
      rect.setAttribute("stroke", n.style?.stroke || "rgba(11,19,36,.18)");
      rect.setAttribute("stroke-width", (selectedId===n.id) ? "3" : "2");
      rect.setAttribute("filter", "drop-shadow(0px 10px 16px rgba(10,20,40,.14))");
      g.appendChild(rect);

      const text = document.createElementNS("http://www.w3.org/2000/svg","text");
      text.setAttribute("y", h/2 + 7);
      text.setAttribute("dominant-baseline","middle");
      text.style.fontFamily = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
      text.style.fontSize = fontSize + "px";
      text.style.fontWeight = String(weight);
      text.style.fontStyle = (n.fmt && n.fmt.italic) ? "italic" : "normal";
      text.style.fill = "rgba(11,19,36,.90)";
      text.textContent = (n.text || "").trim() || "–ò–¥–µ—è";

      const align = (n.fmt && n.fmt.align) ? n.fmt.align : "center";
      if (align === "left"){
        text.setAttribute("text-anchor","start");
        text.setAttribute("x", 18);
      } else if (align === "right"){
        text.setAttribute("text-anchor","end");
        text.setAttribute("x", w - 18);
      } else {
        text.setAttribute("text-anchor","middle");
        text.setAttribute("x", w/2);
      }

      g.appendChild(text);

      g.addEventListener("pointerdown", (e) => {
        if (editingId) return;
        e.stopPropagation();
        selectedId = n.id;
        ctxOpen = false;
        renderAll();
      });

      g.addEventListener("pointerdown", (e) => {
        if (editingId) return;
        e.stopPropagation();
        startNodeDrag(e, n.id);
      });

      hookTapLogic(g, n.id);

      nodesG.appendChild(g);

      const kids = childrenOf(n.id);
      if (kids.length){
        const dot = document.createElementNS("http://www.w3.org/2000/svg","g");
        dot.setAttribute("data-dot-for", n.id);
        dot.setAttribute("transform", `translate(${n.x + w + 12} ${n.y + h/2 - 10})`);
        dot.style.cursor = "pointer";

        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx", 10);
        c.setAttribute("cy", 10);
        c.setAttribute("r", 10);
        c.setAttribute("fill","rgba(255,255,255,.92)");
        c.setAttribute("stroke", n.style?.stroke || "rgba(11,19,36,.22)");
        c.setAttribute("stroke-width","2");
        dot.appendChild(c);

        const inner = document.createElementNS("http://www.w3.org/2000/svg","circle");
        inner.setAttribute("cx", 10);
        inner.setAttribute("cy", 10);
        inner.setAttribute("r", 6);
        inner.setAttribute("fill", n.style?.stroke || "rgba(11,19,36,.22)");
        inner.setAttribute("opacity", n.collapsed ? "0.75" : "0.28");
        dot.appendChild(inner);

        dot.addEventListener("pointerdown", (e) => {
          e.stopPropagation();
          toggleCollapse(n.id);
        });

        nodesG.appendChild(dot);
      }
    }
  }

  function renderDotsAndCtx(){
    clear(dotsG);
    clear(ctxG);

    if (!selectedId) { dotsG.style.display="none"; ctxG.style.display="none"; return; }
    const n = getNode(selectedId);
    if (!n || isHiddenByCollapse(selectedId)) { dotsG.style.display="none"; ctxG.style.display="none"; return; }

    const {w,h} = nodeBox(n);
    const dotX = n.x + w/2;
    const dotY = n.y + h + 14;

    const bg = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bg.setAttribute("cx", dotX);
    bg.setAttribute("cy", dotY);
    bg.setAttribute("r", 11);
    bg.setAttribute("fill", "rgba(255,255,255,.92)");
    bg.setAttribute("stroke", n.style?.stroke || "rgba(11,19,36,.22)");
    bg.setAttribute("stroke-width", "2");
    dotsG.appendChild(bg);

    const dColor = n.style?.stroke || "rgba(11,19,36,.75)";
    [-4,0,4].forEach(dx => {
      const dc = document.createElementNS("http://www.w3.org/2000/svg","circle");
      dc.setAttribute("cx", dotX + dx);
      dc.setAttribute("cy", dotY);
      dc.setAttribute("r", 1.6);
      dc.setAttribute("fill", dColor);
      dotsG.appendChild(dc);
    });

    dotsG.style.display = "block";
    dotsG.onpointerdown = (e) => {
      e.stopPropagation();
      ctxOpen = !ctxOpen;
      renderAll();
    };

    if (!ctxOpen){ ctxG.style.display="none"; return; }

    const boxW = 420;
    const boxH = 54;
    const boxX = Math.max(10, dotX - boxW/2);
    const boxY = dotY + 16;

    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", boxX);
    rect.setAttribute("y", boxY);
    rect.setAttribute("width", boxW);
    rect.setAttribute("height", boxH);
    rect.setAttribute("rx", 14);
    rect.setAttribute("fill", "rgba(20,28,40,.92)");
    rect.setAttribute("stroke", "rgba(255,255,255,.10)");
    rect.setAttribute("stroke-width","1");
    rect.setAttribute("filter", "drop-shadow(0px 18px 30px rgba(10,20,40,.18))");
    ctxG.appendChild(rect);

    const items = [
      {label:"‚Ü≥", action:()=>addChildFrom(selectedId)},
      {label:"‚úèÔ∏è", action:()=>beginEdit(selectedId,true)},
      {label:"‚§µÔ∏è", action:()=>toggleCollapse(selectedId)},
      {label:"üóëÔ∏è", action:()=>deleteSubtree(selectedId)},
      {label:"‚úñ", action:()=>{ctxOpen=false; renderAll();}}
    ];

    const startX = boxX + 14;
    const startY = boxY + 10;
    const gap = 8;
    const btn = 34;

    items.forEach((it, i) => {
      const x = startX + i*(btn+gap);
      const y = startY;

      const b = document.createElementNS("http://www.w3.org/2000/svg","rect");
      b.setAttribute("x", x);
      b.setAttribute("y", y);
      b.setAttribute("width", btn);
      b.setAttribute("height", btn);
      b.setAttribute("rx", 10);
      b.setAttribute("fill", "rgba(255,255,255,.06)");
      b.setAttribute("stroke", "rgba(255,255,255,.10)");
      b.setAttribute("stroke-width","1");
      b.style.cursor = "pointer";
      b.onpointerdown = (e) => { e.stopPropagation(); it.action(); };
      ctxG.appendChild(b);

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", x + btn/2);
      t.setAttribute("y", y + btn/2 + 1);
      t.setAttribute("text-anchor","middle");
      t.setAttribute("dominant-baseline","middle");
      t.style.fontFamily = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";
      t.style.fontWeight = "700";
      t.style.fontSize = "16px";
      t.style.fill = "rgba(255,255,255,.92)";
      t.textContent = it.label;
      t.style.pointerEvents = "none";
      ctxG.appendChild(t);
    });

    ctxG.style.display = "block";
  }

  function renderAll(){
    applyTransform();
    renderLinks();
    renderNodes();
    renderDotsAndCtx();
  }

  // ---------- Editor ----------
  function beginEdit(id, selectAll=false){
    const n = getNode(id);
    if (!n) return;

    editingId = id;
    ctxOpen = false;
    renderAll();

    const {w,h} = nodeBox(n);
    const p = worldToClient(n.x, n.y);
    const k = map.view.k;

    editor.style.left = (p.x) + "px";
    editor.style.top  = (p.y) + "px";
    editor.style.width = (w * k) + "px";
    editor.style.height = (h * k) + "px";
    editor.style.fontSize = Math.max(14, Math.round(20 * k)) + "px";
    editor.style.textAlign = "center";

    editor.value = (n.text || "").trim() || "–ò–¥–µ—è";
    editor.style.display = "block";
    editor.focus();
    if (selectAll) editor.select();

    const finish = (save) => {
      editor.onkeydown = null;
      editor.onblur = null;
      editor.style.display = "none";
      if (save){
        n.text = (editor.value || "").trim() || "–ò–¥–µ—è";
        autosave();
      }
      editingId = null;
      renderAll();
    };

    editor.onkeydown = (e) => {
      if (e.key === "Enter"){ e.preventDefault(); editor.blur(); }
      else if (e.key === "Escape"){ e.preventDefault(); finish(false); }
    };
    editor.onblur = () => finish(true);
  }

  // ---------- Tap logic ----------
  const tap = { id:null, count:0, t:0, timer:null };
  const TAP_WINDOW = 420;

  function hookTapLogic(el, id){
    el.addEventListener("pointerup", (e) => {
      if (editingId) return;
      if (drag && drag.moved) return;

      const now = Date.now();
      const same = (tap.id === id) && (now - tap.t <= TAP_WINDOW);
      tap.id = id;
      tap.t = now;
      tap.count = same ? (tap.count + 1) : 1;

      if (tap.timer) clearTimeout(tap.timer);
      tap.timer = setTimeout(() => {
        if (tap.id !== id) return;
        if (tap.count === 2) addChildFrom(id);
        else if (tap.count >= 3) beginEdit(id, true);
        tap.id=null; tap.count=0; tap.timer=null;
      }, TAP_WINDOW + 30);
    });
  }

  // ---------- Dragging / pan ----------
  let drag = null;

  function startNodeDrag(e, nodeId){
    const n = getNode(nodeId);
    if (!n) return;
    drag = { kind:"node", id:nodeId, pid:e.pointerId, sx:e.clientX, sy:e.clientY, baseX:n.x, baseY:n.y, moved:false };
    svg.setPointerCapture(e.pointerId);
  }

  svg.addEventListener("pointermove", (e) => {
    if (!drag) return;

    if (drag.kind === "node"){
      const dx = (e.clientX - drag.sx) / map.view.k;
      const dy = (e.clientY - drag.sy) / map.view.k;
      if (!drag.moved && Math.hypot(dx,dy) > 2) drag.moved = true;
      if (!drag.moved) return;

      const n = getNode(drag.id);
      if (!n) return;
      n.x = drag.baseX + dx;
      n.y = drag.baseY + dy;
      autosave();
      renderAll();
    }

    if (drag.kind === "pan"){
      const dx = e.clientX - drag.sx;
      const dy = e.clientY - drag.sy;
      if (!drag.moved && Math.hypot(dx,dy) > 4) drag.moved = true;
      if (!drag.moved) return;
      map.view.x = drag.baseX + dx;
      map.view.y = drag.baseY + dy;
      applyTransform();
    }
  });

  svg.addEventListener("pointerup", (e) => {
    if (drag && drag.pid === e.pointerId){
      try{ svg.releasePointerCapture(e.pointerId); }catch(_){}
      drag = null;
    }
  });

  // –ø–∞–Ω –Ω–∞ –ø—É—Å—Ç–æ–º
  svg.addEventListener("pointerdown", (e) => {
    if (editingId) return;

    const onNode = safeClosest(e.target, '[data-id]') || safeClosest(e.target, '[data-dot-for]');
    const onMenu = safeClosest(e.target, '#ctx') || safeClosest(e.target, '#dots');

    if (!onNode && !onMenu){
      selectedId = null;
      ctxOpen = false;
      renderAll();

      drag = { kind:"pan", pid:e.pointerId, sx:e.clientX, sy:e.clientY, baseX:map.view.x, baseY:map.view.y, moved:false };
      svg.setPointerCapture(e.pointerId);
    }
  });

  // –î–∞–±–ª–∫–ª–∏–∫ –Ω–∞ –ø—É—Å—Ç–æ–º -> –Ω–æ–≤–∞—è –∏–¥–µ—è
  svg.addEventListener("dblclick", (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (editingId) return;

    const onNode = safeClosest(e.target, '[data-id]') || safeClosest(e.target, '[data-dot-for]');
    const onMenu = safeClosest(e.target, '#ctx') || safeClosest(e.target, '#dots');
    if (onNode || onMenu) return;

    const p = clientToWorld(e.clientX, e.clientY);
    const id = uid();
    map.nodes.push({
      id,
      x: p.x - 90,
      y: p.y - 32,
      text:"–ù–æ–≤–∞—è –∏–¥–µ—è",
      style:{...PALETTE[0]},
      parentId:null,
      collapsed:false,
      childColorNext:0,
      fmt:{bold:false, italic:false, align:"center"}
    });
    selectedId = id;
    autosave();
    renderAll();
    beginEdit(id, true);
  });

  // –∞–Ω—Ç–∏-—è–Ω–¥–µ–∫—Å ‚Äú–ø–µ—Ä–µ–≤–µ—Å—Ç–∏/–Ω–∞–π—Ç–∏‚Äù –Ω–∞ dblclick –ø–æ —Ö–æ–ª—Å—Ç—É
  wrap.addEventListener("dblclick", (e) => {
    e.preventDefault();
  });

  // zoom
  wrap.addEventListener("wheel", (e) => {
    e.preventDefault();
    if (!map) return;

    const delta = Math.sign(e.deltaY);
    const step = 0.08;
    let nk = map.view.k + (delta > 0 ? -step : step);
    nk = Math.max(0.25, Math.min(3.5, nk));
    nk = Math.round(nk / step) * step;

    const before = clientToWorld(e.clientX, e.clientY);
    const r = svg.getBoundingClientRect();
    const vx = e.clientX - r.left;
    const vy = e.clientY - r.top;

    map.view.k = nk;
    map.view.x = vx - before.x * nk;
    map.view.y = vy - before.y * nk;

    applyTransform();
    renderDotsAndCtx();
    autosave();
  }, {passive:false});

  // ---------- Projects UI ----------
  function rebuildProjectsUI(){
    const projects = Object.values(store.projects).sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
    projList.innerHTML = "";
    projects.forEach(p => {
      const item = document.createElement("div");
      item.className = "ddItem";
      item.innerHTML = `<span>${escapeHtml(p.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</span><span class="ddMeta">${new Date(p.updatedAt||p.createdAt||Date.now()).toLocaleDateString()}</span>`;
      item.onclick = () => { setActiveProject(p.id); projList.style.display="none"; };
      projList.appendChild(item);
    });

    const ap = store.projects[store.activeId];
    projBtnText.textContent = ap ? (ap.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è") : "–ú–∞–π–Ω–¥–º—ç–ø";
  }

  projBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault(); e.stopPropagation();
    projList.style.display = (projList.style.display === "block") ? "none" : "block";
    downloadDrop.style.display = "none";
  });
  document.addEventListener("pointerdown", (e) => {
    if (e.target.closest("#projDD")) return;
    projList.style.display = "none";
  });

  projNew.onclick = () => {
    const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞–π–Ω–¥–º—ç–ø–∞:", "–ù–æ–≤—ã–π –º–∞–π–Ω–¥–º—ç–ø");
    const p = createEmptyProject((name || "–ù–æ–≤—ã–π –º–∞–π–Ω–¥–º—ç–ø").trim());
    rebuildProjectsUI();
    setActiveProject(p.id);
    showToast("–°–æ–∑–¥–∞–Ω–æ");
  };

  function setActiveProject(id){
    const p = store.projects[id];
    if (!p) return;

    // –∑–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ –ø–æ—á–µ–º—É-—Ç–æ –Ω–µ—Ç —É–∑–ª–æ–≤ ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º
    if (!p.data || !Array.isArray(p.data.nodes) || !p.data.nodes.length){
      p.data = createEmptyProject(p.name || "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ").data;
      saveStore();
    }

    store.activeId = id;
    active = p;
    map = JSON.parse(JSON.stringify(p.data));

    selectedId = null;
    editingId = null;
    ctxOpen = false;

    saveStore();
    rebuildProjectsUI();
    renderAll();
  }

  // ---------- Download menu ----------
  function closeDownload(){ downloadDrop.style.display = "none"; }
  downloadBtn.addEventListener("pointerdown", (e) => {
    e.preventDefault(); e.stopPropagation();
    downloadDrop.style.display = (downloadDrop.style.display === "block") ? "none" : "block";
    projList.style.display = "none";
  });
  document.addEventListener("pointerdown", (e) => {
    if (e.target.closest(".menuWrap")) return;
    closeDownload();
  });

  exportOneBtn.onclick = () => {
    commitMap();
    const payload = { kind:"mindmap_project", version:9, project: store.projects[store.activeId] };
    downloadJson(payload, safeName(active.name || "mindmap") + ".json");
    closeDownload();
    showToast("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ");
  };

  exportAllBtn.onclick = () => {
    commitMap();
    const payload = { kind:"mindmap_store", version:9, store };
    downloadJson(payload, "mindmaps_all.json");
    closeDownload();
    showToast("–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –≥–æ—Ç–æ–≤");
  };

  importOne.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      try{
        const obj = JSON.parse(fr.result);
        if (!obj || obj.kind !== "mindmap_project" || !obj.project) throw new Error("bad");
        const p = obj.project;
        if (!p.id) p.id = uid();
        p.createdAt ||= nowTs();
        p.updatedAt ||= nowTs();
        store.projects[p.id] = p;
        store.activeId = p.id;
        saveStore();
        rebuildProjectsUI();
        setActiveProject(p.id);
        showToast("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ");
      }catch(err){
        showToast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
      }
    };
    fr.readAsText(f);
    e.target.value = "";
    closeDownload();
  });

  importAll.addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      try{
        const obj = JSON.parse(fr.result);
        if (!obj || obj.kind !== "mindmap_store" || !obj.store) throw new Error("bad");
        const s = obj.store;
        if (!s.projects || typeof s.projects !== "object") throw new Error("bad");
        store = s;
        if (!store.activeId || !store.projects[store.activeId]){
          store.activeId = Object.keys(store.projects)[0];
        }
        saveStore();
        rebuildProjectsUI();
        setActiveProject(store.activeId);
        showToast("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω");
      }catch(err){
        showToast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞");
      }
    };
    fr.readAsText(f);
    e.target.value = "";
    closeDownload();
  });

  // ---------- Init ----------
  rebuildProjectsUI();
  setActiveProject(store.activeId);

})();
</script>
</body>
</html>
